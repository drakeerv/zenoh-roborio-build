build-rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: eclipse-zenoh/zenoh-java
          ref: ${{ github.event.inputs.version }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabi

      - name: Install Zigbuild
        run: cargo install cargo-zigbuild

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Prepare Rust Environment
        run: |
          find . -name "rust-toolchain" -delete
          find . -name "rust-toolchain.toml" -delete
          rustup target add armv7-unknown-linux-gnueabi

      - name: Download ARM System Libraries
        # We download libatomic1 (armhf) from Debian so the linker can find it.
        # We use 'dpkg -x' to extract it without installing it on the host system.
        run: |
          wget http://ftp.us.debian.org/debian/pool/main/g/gcc-12/libatomic1_12.2.0-14_armhf.deb
          mkdir -p target-libs
          dpkg -x libatomic1_12.2.0-14_armhf.deb target-libs
          
          # The linker looks for 'libatomic.so', but the deb contains 'libatomic.so.1'.
          # We copy/rename it so the linker (-latomic) finds it immediately.
          cp target-libs/usr/lib/arm-linux-gnueabi/libatomic.so.1.2.0 target-libs/libatomic.so

      - name: Patch Rust for RoboRIO Compatibility
        run: |
          # Patch gettid for older glibc 2.24
          echo '
          #[no_mangle]
          pub extern "C" fn gettid() -> i32 {
              unsafe { libc::syscall(libc::SYS_gettid) as i32 }
          }
          ' >> zenoh-jni/src/lib.rs
          
          # Add libc dependency
          sed -i '/\[dependencies\]/a libc = "0.2"' zenoh-jni/Cargo.toml

      - name: Build for RoboRIO
        working-directory: zenoh-jni
        env:
          # CRITICAL ABI FIXES:
          # 1. target-cpu=cortex-a9: Optimize for Zynq 7000.
          # 2. target-feature=+v7,+vfp3,+neon: Enable Hardware Floats (SoftFP ABI).
          #    This aligns registers with the JVM's expectation.
          # 3. -L native=...: Tells the linker where to find the libatomic.so we just downloaded.
          # 4. -latomic: Links the library.
          RUSTFLAGS: >
            -C target-cpu=cortex-a9 
            -C target-feature=+v7,+vfp3,+neon 
            -L native=${{ github.workspace }}/target-libs 
            -C link-arg=-latomic
            -C strip=symbols
            
          CFLAGS: "-march=armv7-a -mcpu=cortex-a9 -mfloat-abi=softfp -mfpu=neon -mthumb"
          CXXFLAGS: "-march=armv7-a -mcpu=cortex-a9 -mfloat-abi=softfp -mfpu=neon -mthumb"
        run: |
          cargo zigbuild --release \
            --target armv7-unknown-linux-gnueabi.2.24 \
            --no-default-features \
            --features "zenoh/transport_udp,zenoh/unstable,zenoh/internal,zenoh-ext"

      - name: Upload Native Artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-lib
          path: zenoh-jni/target/armv7-unknown-linux-gnueabi/release/libzenoh_jni.so
